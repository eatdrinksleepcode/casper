#! /bin/sh

myDir="`dirname \"$0\"`"
localNugetConfig=$myDir/.local-nuget.config
cp $myDir/local-nuget.config $localNugetConfig

#$myDir/build Debug || exit $?
echo Installing old Casper...
oldPackageDir=$myDir/.casper/old
mkdir -p $oldPackageDir
$myDir/nuget install Casper.Console -Version 0.1.0-ci0146 -OutputDirectory $oldPackageDir -pre -Verbosity quiet -Source "MyGet" -ConfigFile $localNugetConfig -ExcludeVersion || exit $?

echo Building new Casper with old Casper...
mono --debug $oldPackageDir/Casper.Console/tools/casper.exe build.casper Build || exit $?

echo Installing new Casper...
newPackageDir=$myDir/.casper/new
rm -r $newPackageDir
mkdir -p $newPackageDir
$myDir/nuget install Casper.Console -ExcludeVersion -OutputDirectory $newPackageDir -pre -Verbosity quiet -Source "Casper Dev" -ConfigFile $localNugetConfig || exit $?

echo Cleaning outputs...
msbuild /t:Clean /verbosity:quiet /nologo || exit $?
msbuild /t:Clean /p:Configuration=Release /verbosity:quiet /nologo || exit $?

echo Building with new Casper...
rm -r $myDir/out
$myDir/casper $@ || exit $?
